name: CareerPath Workflow - (with SonarQube)

on:
  push:
    branches: ['main']
    paths-ignore:
      - 'README.md'
  
  pull_request:
    branches: ['main']
    paths-ignore:
      - 'README.md'
  
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  BUILD_OUTPUT: './publish_output'

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      sonarqube:
        image: sonarqube:lts
        ports:
          - 9000:9000
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
        options: >-
          --health-cmd="exit 0"
          -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
          -e ES_JAVA_OPTS="-Xms512m -Xmx512m"
        
    steps:

      - uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Wait for SonarQube to start
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:9000 >/dev/null; then
              echo "SonarQube is up !!!"; break;
            fi
            echo "Waiting for SonarQube...."; sleep 10
          done

      - name: Install SonarScanner
        uses: sonarsource/sonarqube-scan-action@v2

      - name: Begin Sonar Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"CareerPathApp" \
            /d:sonar.host.url="http://sonarqube:9000" \
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"

      - name: Restore dependencies
        run: dotnet restore ./CareerPath.sln

      - name: Build
        run: dotnet build ./API/API.csproj --configuration Release

      - name: Test (Generate Coverage)
        run: dotnet test ./API.Tests/API.Tests.csproj \
          --collect:"XPlat Code Coverage" \
          --results-directory "./TestResults"

      - name: Convert Coverage to OpenCover
        run: |
          report=$(find ./TestResults -name "coverage.cobertura.xml" | head -n 1)
          echo "Found report: $report"
          dotnet tool install --global dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:$report \
            -targetdir:coveragereport \
            -reporttypes:opencover

      - name: End Sonar Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner end \
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      - name: Clean API publish output
        run: rm -rf ${{ env.BUILD_OUTPUT }}

      - name: Publish
        run: dotnet publish ./API/API.csproj -c Release -o ${{ env.BUILD_OUTPUT }} --no-build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-app
          path: ${{ env.BUILD_OUTPUT }}

      - name: Upload Coverage Report (optional)
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: coveragereport


#  deploy:
#    runs-on: ubuntu-latest
#    needs: build
#    
#    environment:
#      name: 'Development'
#      url: ${{steps.deploy-to-azure-web-app.outputs.webapp-url}}
#    
#    steps:
#      - name: checkout
#        uses: actions/checkout@v5
#
#      - name: Download artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: dotnet-app
#          path: ${{env.BUILD_OUTPUT}}
#
#      - name: Azure login
#        uses: azure/login@v2
#        with:
#          creds: ${{secrets.AZURE_CREDENTIALS}}
#      
#      # below step will create azure resources - using main_dev.bicep file.
#      - name: Deploy azure resources - using main_dev.bicep file
#        uses: azure/CLI@v2
#        with:
#          inlineScript: |
#            az group create --name ticketifyne-dev-resgrp --location centralindia
#            az deployment group create \
#            --resource-group ticketifyne-dev-resgrp \
#            --template-file .github/infra/templates/main_dev.bicep \
#            --parameters webAppName=${{env.AZURE_WEBAPP_NAME}} \
#            sqlAdminPassword=${{secrets.AZURE_SQL_PASSWORD}} 
#
#      - name: Deploy to azure web app
#        id: deploy-to-azure
#        uses: azure/webapps-deploy@v3
#        with:
#          app-name: ${{env.AZURE_WEBAPP_NAME}}
#          package: ${{env.BUILD_OUTPUT}}
